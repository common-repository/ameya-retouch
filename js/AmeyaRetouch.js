!function(e){var t={};function i(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(a,n,function(t){return e[t]}.bind(null,n));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";i.r(t);let a=(()=>{class e{static init(){this.notifier=document.getElementById("ameyaretouchnotifier")}static notify(e){this.notifier.textContent=e,this.notifier.classList.add("visible")}static hideNotify(){this.notifier.classList.remove("visible")}}return e.html='<div id="ameyaretouchnotifier"></div>',e.css="#ameyaretouchnotifier {position:absolute;bottom:0;left:100%;width:300px;background:rgba(0,0,0,0.5);padding:10px;box-sizing:border-box;font-size:13px;opacity:0;transition:all 0.3s;visibility:hidden;}#ameyaretouchnotifier.visible {opacity:1;visibility:visible;}",e})(),n=(()=>{class e{static init(e){this.dic=Object.assign(this.dic,e)}static of(t){return e.dic[t]}}return e.dic={scale:"Scale: ",rotate:"Rotate: ",contrast:"Contrast: ",brightness:"Brightness: ",temperature:"Temperature",crop:"crop",cancel:"Cancel",ok:"OK"},e})(),s=(()=>{class e{static init(){this.canvas=document.getElementById("ameyaretouchcanvas"),this.ctx=this.canvas.getContext("2d")}static resize(e,t){this.canvas.width=e,this.canvas.height=t,this.ctx.clearRect(0,0,e,t)}static reposition(e,t,i,a){this.ctx.translate(.5*e,.5*t),this.ctx.rotate(i),this.ctx.translate(-e*a*.5,-t*a*.5)}static translate(e,t,i){const a=.5*(t-this.canvas.width),n=.5*(i-this.canvas.height);this.ctx.translate(-(e.x+1)*a,-(e.y+1)*n)}}return e.html='<canvas id="ameyaretouchcanvas"></canvas>',e.css="#ameyaretouchcanvas {position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;}",e})(),o=(()=>{class e{static init(t,i,n,o){this.cropper=document.getElementById("ameyaretouchcropper");let r=i,c=n;const d=()=>{this.movex=this.cropper.getBoundingClientRect().left-s.canvas.getBoundingClientRect().left,this.movey=this.cropper.getBoundingClientRect().top-s.canvas.getBoundingClientRect().top};this.cropper.addEventListener("mouseleave",()=>{a.hideNotify()},!1),this.cropper.addEventListener("mouseenter",()=>{this.measure(),a.notify("x:"+e.movex+", y:"+e.movey+", "+this.fw+"x"+this.fh)},!1),this.cropper.querySelector("button").addEventListener("click",()=>{h.img&&(h.scale=.001*parseInt(document.getElementById("ameyaretouchscale").value),h.saveHistory(h.img),this.measure(),h.crop(this.movex,this.movey,this.fw,this.fh,h.scale),h.updateScale(),h.update(),e.cropper.style.display="none")},!1),s.canvas.addEventListener("mousedown",t=>{if(s.canvas.width<r||s.canvas.height<c)return;if(e.resize)return;let i=t.pageY-.5*c,a=t.pageX-.5*r;i<s.canvas.getBoundingClientRect().top&&(i=s.canvas.getBoundingClientRect().top),i+c>s.canvas.getBoundingClientRect().top+s.canvas.height&&(i=s.canvas.getBoundingClientRect().top+s.canvas.height-c),a<s.canvas.getBoundingClientRect().left&&(a=s.canvas.getBoundingClientRect().left),a+r>s.canvas.getBoundingClientRect().left+s.canvas.width&&(a=s.canvas.getBoundingClientRect().left+s.canvas.width-r),e.cropper.style.width=r+"px",e.cropper.style.height=c+"px",e.cropper.style.top=i+"px",e.cropper.style.left=a+"px",e.cropper.style.display="block",d()},!1),this.cropper.addEventListener("mousedown",()=>{e.resize||(e.moving=!0)},!1),this.cropper.addEventListener("mousemove",t=>{if(!e.moving)return!1;let i=t.pageY-.5*c,a=t.pageX-.5*r;const n=s.canvas.getBoundingClientRect().top,o=s.canvas.getBoundingClientRect().left;i<s.canvas.getBoundingClientRect().top&&(i=n),i+c>s.canvas.getBoundingClientRect().top+s.canvas.height&&(i=n+s.canvas.height-c),a<s.canvas.getBoundingClientRect().left&&(a=o),a+r>s.canvas.getBoundingClientRect().left+s.canvas.width&&(a=o+s.canvas.width-r),e.cropper.style.left=a+"px",e.cropper.style.top=i+"px"},!1);if(this.cropper.addEventListener("mouseup",()=>{e.moving=!1,d(),this.measure(),a.notify("x:"+e.movex+", y:"+e.movey+", "+this.fw+"x"+this.fh)},!1),!t){this.cropper.appendChild(h.createEl("div",{id:"ameyaretouchcroppertop",class:"ameyaretouchcropperpoint"},"")),this.cropper.appendChild(h.createEl("div",{id:"ameyaretouchcropperright",class:"ameyaretouchcropperpoint"},"")),this.cropper.appendChild(h.createEl("div",{id:"ameyaretouchcropperbottom",class:"ameyaretouchcropperpoint"},"")),this.cropper.appendChild(h.createEl("div",{id:"ameyaretouchcropperleft",class:"ameyaretouchcropperpoint"},""));const t=()=>{e.resize=null,this.measure(),r=this.fw,c=this.fh,d()},i=t=>{if(e.resize){let i;const a=s.canvas.getBoundingClientRect().left,n=s.canvas.getBoundingClientRect().top;switch(e.resize){case"top":i=t.pageY-e.resizepagecoord,e.resizeorigincoord.top+i<n&&(i=n-e.resizeorigincoord.top),e.cropper.style.top=e.resizeorigincoord.top+i+"px",e.cropper.style.height=e.resizeoriginh-i+"px";break;case"bottom":i=t.pageY-e.resizepagecoord,e.resizeorigincoord.top+e.resizeoriginh+i>n+s.canvas.height&&(i=n+s.canvas.height-e.resizeorigincoord.top-e.resizeoriginh),e.cropper.style.height=e.resizeoriginh+i+"px";break;case"left":i=t.pageX-e.resizepagecoord,e.resizeorigincoord.left+i<a&&(i=a-e.resizeorigincoord.left),e.cropper.style.left=e.resizeorigincoord.left+i+"px",e.cropper.style.width=e.resizeoriginw-i+"px";break;case"right":i=t.pageX-e.resizepagecoord,e.resizeorigincoord.left+e.resizeoriginw+i>a+s.canvas.width&&(i=a+s.canvas.width-e.resizeorigincoord.left-e.resizeoriginw),e.cropper.style.width=e.resizeoriginw+i+"px"}if(o){let t;this.measure(),"top"==e.resize||"bottom"==e.resize?(t=this.fh*o,i=.5*(e.resizeoriginw-t),e.cropper.style.left=e.resizeorigincoord.left+i+"px",e.cropper.style.width=t+"px"):(t=this.fw/o,i=.5*(e.resizeoriginh-t),e.cropper.style.top=e.resizeorigincoord.top+i+"px",e.cropper.style.height=t+"px")}}},a=(t,i)=>{e.resize=t,e.resizepagecoord=i,e.resizeorigincoord={top:e.cropper.getBoundingClientRect().top,left:e.cropper.getBoundingClientRect().left},this.measure(),e.resizeoriginw=this.fw,e.resizeoriginh=this.fh};let n=document.getElementById("ameyaretouchcroppertop");n.addEventListener("mousedown",e=>{a("top",e.pageY)},!1),n.addEventListener("mouseup",t,!1),n=document.getElementById("ameyaretouchcropperbottom"),n.addEventListener("mousedown",e=>{a("bottom",e.pageY)},!1),n.addEventListener("mouseup",t,!1),n=document.getElementById("ameyaretouchcropperleft"),n.addEventListener("mousedown",e=>{a("left",e.pageX)},!1),n.addEventListener("mouseup",t,!1),n=document.getElementById("ameyaretouchcropperright"),n.addEventListener("mousedown",e=>{a("right",e.pageX)},!1),n.addEventListener("mouseup",t,!1),s.canvas.addEventListener("mousemove",i,!1),s.canvas.addEventListener("mouseup",t,!1),this.cropper.addEventListener("mousemove",i,!1)}}static hide(){this.cropper&&(this.cropper.style.display="none")}static measure(){const t=document.defaultView.getComputedStyle(e.cropper,null);this.fw=parseInt(t.width),this.fh=parseInt(t.height)}}return e.moving=!1,e.resize=null,e.html='<div id="ameyaretouchcropper"><button>'+n.of("crop")+"</button></div>",e.css="#ameyaretouchcropper {display:none;position:absolute;}#ameyaretouchcropper::before {content:'';display:block;outline-style:solid;outline-width:2px;position:absolute;top:0px;left:0px;width:100%;height:100%;}#ameyaretouchcropper button {position:absolute;top:calc(100% + 12px);left:0;right:0;width:100%;border:1px solid white;background:black;color:white;margin:auto;-ms-user-select:none;-webkit-user-select:none;-moz-user-select:none;user-select:none;}.ameyaretouchcropperpoint {position:absolute;width:30px;height:30px;}.ameyaretouchcropperpoint::after {content:'';position:absolute;top:10px;left:10px;width:10px;height:10px;background:rgba(255,255,255,.5);border-radius:5px;}.ameyaretouchcropperpoint:hover::after {background:rgba(127,127,127,.8);}#ameyaretouchcroppertop {top:-16px;left:calc(50% - 15px);cursor:n-resize;}#ameyaretouchcropperbottom {bottom:-16px;left:calc(50% - 15px);cursor:s-resize;}#ameyaretouchcropperleft {left:-16px;top:calc(50% - 15px);cursor:w-resize;}#ameyaretouchcropperright {right:-16px;top:calc(50% - 15px);cursor:e-resize;}",e})(),r=(()=>{class e{static init(e){this.pref=e}static prepare(){this.cont=document.getElementById("ameyaretouchbuttoncontainer"),this.pref.forEach(e=>{const t=e.command,i=e.title;let a,n;switch(t){case"save":let t=e.action,d={};if(t.match(/\?/)){const e=t.split("?");t=e[0];const i=e[1].split("&");for(let e=0;e<i.length;e++){const t=i[e].split("=");d[t[0]]=t[1]}}r=t,c=d,a=function(){h.save(r,c)},this.addButton(i,a);break;case"scale":const l=e.dir,p=e.size;"w"==l?n=this.addButton(i,(function(){document.getElementById("ameyaretouchscale").value=String(1e3*this.dataset.size/h.img.width)})):"h"==l&&(n=this.addButton(i,(function(){document.getElementById("ameyaretouchscale").value=String(1e3*this.dataset.size/h.img.height)}))),n.dataset.size=p;break;case"sizefix":a=function(e,t){return function(){h.changeSizeFix(e,t)}}(e.width,e.height),this.addButton(i,a);break;case"crop":const u=e.width,m=e.height;n=this.addButton(i,(function(){const e=this.dataset.w,t=this.dataset.h;if(h.saveHistory(h.img),e/t>h.img.width/h.img.height){const i=h.img.width*t/e;h.crop(0,(h.img.height-i)/2,h.img.width,i,1),h.downsizing(e/h.img.width,0)}else{const i=h.img.height*e/t;h.crop((h.img.width-i)/2,0,i,h.img.height,1),h.downsizing(t/h.img.height,0)}document.getElementById("ameyaretouchscale").value=String(1e3*e/h.img.width)})),n.dataset.w=u,n.dataset.h=m;break;case"rotate":const g=(e.deg+360)%360;o=g,a=function(){h.rotates(o)},this.addButton(i,a);break;case"close":this.addButton(i,()=>{h.quit()});break;case"undo":this.addButton(i,()=>{h.loadHistory()});break;case"blur":s=e,a=function(){h.openBlur(s)},this.addButton(i,a);break;case"temperature":this.addButton(i,h.openTemperature)}var s,o,r,c})}static addButton(e,t){const i=h.createEl("button",{},e);return i.addEventListener("click",(function(){o.hide(),t.call(this),document.getElementById("ameyaretouchcontainer")&&h.update()}),!1),this.cont.appendChild(i),i}}return e.html='<div id="ameyaretouchbuttoncontainer"></div>',e.css="#ameyaretouchtoolcontainer button,#ameyaretouchmasktoolcontainer button {border:1px solid white;background:black;color:white;margin-right:5px;}",e.pref=[],e})(),c=(()=>{class e{static openMask(){document.body.appendChild(h.createEl("div",{id:"ameyaretouchmask"},'<canvas></canvas><div id="ameyaretouchmasktoolcontainer"><button id="ameyaretouchmaskcancel">'+n.of("cancel")+'</button><button id="ameyaretouchmaskok">'+n.of("ok")+"</button></div>")),document.getElementById("ameyaretouchtoolcontainer").style.display="none";const e=document.querySelector("#ameyaretouchmask canvas");e.setAttribute("width",String(s.canvas.width)),e.setAttribute("height",String(s.canvas.height))}static closeMask(){document.getElementById("ameyaretouchmask").remove(),document.getElementById("ameyaretouchtoolcontainer").style.display="block"}static addMaskFilter(e,t,i,a,n,s,o){if(!document.getElementById("ameyaretouchmaskfiltercontainer")){const e=document.getElementById("ameyaretouchmasktoolcontainer");e.insertBefore(h.createEl("div",{id:"ameyaretouchmaskfiltercontainer"},""),e.firstElementChild)}const r=document.getElementById("ameyaretouchmaskfiltercontainer");r.appendChild(h.createEl("span",{},t+": ")),r.appendChild(h.createEl("input",{type:"range",id:e,max:a,min:n,step:s,value:i},"")),r.appendChild(document.createElement("br")),document.getElementById(e).addEventListener("change",()=>{h.update()},!1),h.filters.push(o),this.maskfunc[e]=o}static deleteMaskFilter(e){const t=document.getElementById(e),i=t.nextElementSibling,a=t.previousElementSibling;"BR"==i.tagName&&i.remove(),"SPAN"==a.tagName&&a.remove(),t.remove(),h.filters.some((t,i)=>{t==this.maskfunc[e]&&h.filters.splice(i,1)}),delete this.maskfunc[e]}static addEventListener(t,i=(()=>{})){document.getElementById("ameyaretouchmaskok").addEventListener("click",()=>{t(),h.update(),e.closeMask()},!1),document.getElementById("ameyaretouchmaskcancel").addEventListener("click",()=>{i(),h.update(),e.closeMask()},!1)}}return e.maskfunc={},e.css="#ameyaretouchmask {position:fixed;top:0;left:0;width:100%;height:100%;z-index:101;}#ameyaretouchmask canvas {position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;}",e})(),h=(()=>{class e{static prepare(t){this.pref={crop:!0,contrast:!0,sizefix:!1,sizefixw:100,sizefixh:100,cropfix:!1,cropfixw:100,cropfixh:100,cropaspect:0},t&&Object.keys(t).forEach(i=>{"string"==i?n.init(t[i]):"button"==i?r.init(t[i]):e.pref[i]=t[i]});const i=this.createEl("div",{id:"ameyaretouchcontainer"},s.html+'<div id="ameyaretouchtoolcontainer"><span>'+n.of("scale")+'</span><input type="range" id="ameyaretouchscale" max="5000" min="1" step="0.01" value="1000" /><br /><span>'+n.of("rotate")+'</span><input type="range" id="ameyaretouchrotate" max="45" min="-45" step="1" value="0" /><br /><div id="ameyaretouchconbricontainer"><span>'+n.of("contrast")+'</span><input type="range" id="ameyaretouchcontrast" max="100" min="0" step="1" value="25" /><br /><span>'+n.of("brightness")+'</span><input type="range" id="ameyaretouchbrightness" max="255" min="0" step="1" value="127" /><br /></div><div id="ameyaretouchfiltercontainer"></div>'+a.html+r.html+"</div>"+o.html+"<style>#ameyaretouchcontainer {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);overflow:hidden;z-index:100;}"+s.css+'#ameyaretouchtoolcontainer,#ameyaretouchmasktoolcontainer {position:absolute;bottom:0px;left:0px;background:rgba(0,0,0,0.5);color:white;padding:10px;-ms-user-select:none;-webkit-user-select:none;-moz-user-select:none;user-select:none;}#ameyaretouchtoolcontainer span,#ameyaretouchmasktoolcontainer span {font-size:16px;width:100px;display:inline-block;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;vertical-align:middle;line-height:1;}#ameyaretouchtoolcontainer input[type="range"],#ameyaretouchmasktoolcontainer input[type="range"] {min-width:300px;width:calc(100% - 120px);vertical-align:middle;}'+r.css+a.css+o.css+c.css+"</style>");if(document.body.appendChild(i),a.init(),s.init(),this.eachEl("#ameyaretouchcontainer,#ameyaretouchcanvas",t=>{const i=function(e){return e.preventDefault(),e.stopPropagation(),!1};t.addEventListener("dragover",i,!1),t.addEventListener("dragenter",i,!1),t.addEventListener("drop",(function(t){const i=t.dataTransfer.files[0];return e.load(i),t.preventDefault(),t.stopPropagation(),!1}),!1)}),this.pref.sizefix){this.pref.crop=!1;const t=document.getElementById("ameyaretouchcanvas");let i,a,n,s,o=!1;t.addEventListener("mousedown",e=>{o=!0,n=e.pageX,s=e.pageY,i=this.translate.x,a=this.translate.y},!1);const r=()=>{o=!1};t.addEventListener("mouseup",r,!1),t.addEventListener("mouseout",r,!1),t.addEventListener("mousemove",t=>{o&&(this.translate.x=i-2*(t.pageX-n)/(Math.round(this.img.width*this.scale)-this.pref.sizefixw),this.translate.y=a-2*(t.pageY-s)/(Math.round(this.img.height*this.scale)-this.pref.sizefixh),this.translate.x>1?this.translate.x=1:this.translate.x<-1&&(this.translate.x=-1),this.translate.y>1?this.translate.y=1:this.translate.y<-1&&(this.translate.y=-1),e.update())},!1)}this.pref.crop&&o.init(this.pref.cropfix,this.pref.cropfixw,this.pref.cropfixh,this.pref.cropaspect),r.prepare(),this.pref.contrast?(document.getElementById("ameyaretouchcontrast").addEventListener("change",()=>{e.update()}),document.getElementById("ameyaretouchbrightness").addEventListener("change",()=>{e.update()})):document.getElementById("ameyaretouchconbricontainer").style.display="none",document.getElementById("ameyaretouchscale").addEventListener("change",()=>{e.update()},!1),document.getElementById("ameyaretouchrotate").addEventListener("change",()=>{e.update()},!1);const h=document.getElementById("ameyaretouchscale"),d=()=>{const e=h?.001*parseInt(h.value):1;a.notify(Math.round(this.img.width*e)+" x "+Math.round(this.img.height*e))},l=()=>{a.hideNotify()},p=document.getElementById("ameyaretouchrotate"),u=document.getElementById("ameyaretouchcontrast"),m=document.getElementById("ameyaretouchbrightness"),g=()=>{a.notify(p.value+" deg")},f=()=>{a.notify(parseInt(u.value)-25)},y=()=>{a.notify(parseInt(m.value)-127)};return h.addEventListener("mouseenter",d,!1),h.addEventListener("mouseup",d,!1),h.addEventListener("input",d,!1),h.addEventListener("mouseleave",l,!1),p.addEventListener("mouseenter",g,!1),p.addEventListener("mouseup",g,!1),p.addEventListener("input",g,!1),p.addEventListener("mouseleave",l,!1),u.addEventListener("mouseenter",f,!1),u.addEventListener("mouseup",f,!1),u.addEventListener("input",f,!1),u.addEventListener("mouseleave",l,!1),m.addEventListener("mouseenter",y,!1),m.addEventListener("mouseup",y,!1),m.addEventListener("input",y,!1),m.addEventListener("mouseleave",l,!1),window.addEventListener("resize",()=>{e.update()},!1),this}static load(t,i){this.filename=t.name,this.ext=this.filename.replace(/^.*\.([^\.]+)$/,"$1");const a=new FileReader;a.onload=function(t){e.orimg=new Image,e.orimg.onload=function(){e.loaded(),document.getElementById("ameyaretouchcontainer")&&e.update(),i&&i()},e.orimg.src=t.target.result},a.readAsDataURL(t)}static loadURL(t,i){this.filename=t.replace(/^.*[\\\/]([^\\\/]+)$/,"$1"),this.ext=this.filename.replace(/^.*\.([^\.]+)$/,"$1"),this.orimg=new Image,this.orimg.onload=function(){e.loaded(),e.update(),i&&i()},this.orimg.src=t}static loaded(){this.img=document.createElement("canvas"),this.img.width=this.orimg.width,this.img.height=this.orimg.height,this.img.getContext("2d").drawImage(this.orimg,0,0),this.updateScale()}static save(t,i,a,n){if(!this.img)return;let o,r;this.ext.match(/jpe?g/i)?(o=s.canvas.toDataURL("image/jpeg"),r="jpeg"):(o=s.canvas.toDataURL("image/png"),r="png");const c=atob(o.replace(/^.*,/,"")),h=new Uint8Array(c.length);for(let e=0;e<c.length;e++)h[e]=c.charCodeAt(e);const d=new Blob([h.buffer],{type:"image/"+r}),l=new FormData;return l.append("image",d,this.filename),l.append("filename",this.filename),l.append("ext",this.ext),l.append("mime",r),Object.keys(i).forEach(e=>{l.append(e,i[e])}),a||(a=e.saveSuccess),n||(n=e.saveFailure),fetch(t,{method:"POST",body:l,credentials:"include"}).then(e=>200===e.status?e.text().then(a):e.text().then(n)),h}static update(){if(this.img){document.getElementById("ameyaretouchcontainer")?(this.rotate=parseInt(document.getElementById("ameyaretouchrotate").value)*Math.PI/180,this.scale=.001*parseInt(document.getElementById("ameyaretouchscale").value)):(this.rotate=0,this.scale=1),e.downsizing(this.scale,this.rotate);const t=this.img.width*this.scale,i=this.img.height*this.scale;e.applyFilters();const a=parseInt(document.getElementById("ameyaretouchcontrast").value),n=parseInt(document.getElementById("ameyaretouchbrightness").value)-127;if(0!=n||25!=a){const e=[],o=a/25;for(let t=0;t<256;t++)e[t]=Math.floor(o*t+125-125*o);const r=s.ctx.getImageData(0,0,t,i);let c=r.data;for(let t=0;t<c.length;t+=4)c[t]=e[c[t]]+n,c[t+1]=e[c[t+1]]+n,c[t+2]=e[c[t+2]]+n;s.ctx.putImageData(r,0,0)}}return this}static downsizing(e,t){const i=Math.round(this.img.width*e),a=Math.round(this.img.height*e),n=Math.max((Math.abs(i*Math.cos(t))+Math.abs(a*Math.sin(t)))/i,(Math.abs(i*Math.sin(t))+Math.abs(a*Math.cos(t)))/a);if(this.pref.sizefix?s.resize(this.pref.sizefixw,this.pref.sizefixh):s.resize(i,a),e<1){const e=document.createElement("canvas"),o=e.getContext("2d"),r=function(e,t){return t*Math.pow(2,Math.floor(Math.log(e/t)/Math.LN2)-1)};let c=e.width=this.img.width,h=e.height=this.img.height;for(o.drawImage(this.img,0,0);c/i>2;){const t=r(c,i),n=r(h,a);o.drawImage(e,0,0,c,h,0,0,t,n),c=t,h=n}s.reposition(i,a,t,n),this.pref.sizefix&&s.translate(this.translate,i,a),s.ctx.scale(n,n),s.ctx.drawImage(e,0,0,c,h,0,0,i,a)}else s.reposition(i,a,t,n),this.pref.sizefix&&s.translate(this.translate,i,a),s.ctx.scale(e*n,e*n),s.ctx.drawImage(this.img,0,0)}static rotates(e){if(!this.img)return;const t=document.createElement("canvas"),i=t.getContext("2d");let a,n;switch(e/90%2==0?(a=t.width=this.img.width,n=t.height=this.img.height):(a=t.width=this.img.height,n=t.height=this.img.width),(e+360)%360){case 90:i.translate(a,0);break;case 180:i.translate(a,n);break;case 270:i.translate(0,n)}i.rotate(e*Math.PI/180),i.drawImage(this.img,0,0),this.img=t,this.pref.sizefix&&this.initSizeFix()}static crop(e,t,i,a,n){const s=document.createElement("canvas"),o=s.getContext("2d");s.width=i,s.height=a;const r=1/n;o.drawImage(this.img,e*r,t*r,i*r,a*r,0,0,i,a),this.img=s}static saveHistory(e){this.history.push(e),this.history.length>10&&this.history.splice(0,this.history.length-10)}static loadHistory(){this.history.length&&(this.img=this.history.pop(),e.updateScale())}static tuneTemperature(){const t=parseInt(document.getElementById("ameyaretouchtemperature").value);if(6600!=t){const i=e.gettemperaturecolor(t),a=s.ctx.getImageData(0,0,e.img.width*e.scale,e.img.height*e.scale),n=a.data;for(let t=0;t<n.length;t+=4){const a=e.getluminance(n[t],n[t+1],n[t+2]),s=e.rgb2hsl(e.blendcolors(n[t],i[0],.15),e.blendcolors(n[t+1],i[1],.15),e.blendcolors(n[t+2],i[2],.15)),o=e.hsl2rgb(s[0],s[1],a);n[t]=o[0],n[t+1]=o[1],n[t+2]=o[2]}s.ctx.putImageData(a,0,0)}}static rgb2hsl(e,t,i){let a,n,s=e/255,o=t/255,r=i/255,c=Math.max(s,o,r),h=Math.min(s,o,r),d=(c+h)/2,l=c-h;return c==h?[0,0,d]:(n=d<=.5?l/(c+h):l/(2-c-h),a=s==c?(o-r)/l:o==c?2+(r-s)/l:4+(s-o)/l,[a,n,d])}static hsl2rgb(e,t,i){let a,n,s=1,o=1,r=1;return e>5&&(e-=6),0!=t&&(n=i<=.5?i*(1-t):i-t*(1-i),a=2*i-n,e<1?(s=a,e<0?(o=n,r=o-e*(a-n)):(r=n,o=e*(a-n)+r)):e<3?(o=a,e<2?(r=n,s=r-(e-2)*(a-n)):(s=n,r=(e-2)*(a-n)+s)):(r=a,e<4?(s=n,o=s-(e-4)*(a-n)):(o=n,s=(e-4)*(a-n)+o))),[255*s,255*o,255*r]}static getluminance(e,t,i){return(Math.max(e,t,i)+Math.min(e,t,i))/512}static gettemperaturecolor(e){let t,i,a;return e<1e3?e=1e3:e>4e4&&(e=4e4),(e*=.01)<=66?(t=255,i=99.4708025861*Math.log(e)-161.1195681661,i<0?i=0:i>255&&(i=255)):(t=329.698727446*Math.pow(e-60,-.1332047592),t<0?t=0:t>255&&(t=255),i=288.1221695283*Math.pow(e-60,-.0755148492),i<0?i=0:i>255&&(i=255)),e>=66?a=255:e<=19?a=0:(a=138.5177312231*Math.log(e-10)-305.0447927307,a<0?a=0:a>255&&(a=255)),[parseInt(t),parseInt(i),parseInt(a)]}static blendcolors(e,t,i){return(1-i)*e+i*t}static addFilter(t,i,a,n,s,o,r){const c=document.getElementById("ameyaretouchfiltercontainer");Array.from(this.createEl("div",{},"<span>"+i+': </span><input type="range" id="'+t+'" max="'+n+'" min="'+s+'" step="'+o+'" value="'+a+'" /><br />').children).forEach(e=>{c.appendChild(e)}),document.getElementById(t).addEventListener("change",e.update,!1),this.filters.push(r)}static applyFilters(){for(let e=0;e<this.filters.length;e++)this.filters[e]()}static quit(){window.removeEventListener("resize",e.update),document.getElementById("ameyaretouchcontainer").remove()}static saveSuccess(e){console.log("success")}static saveFailure(e,t,i){console.log("failure")}static setUploadArea(t,i){!function(t,i){s.canvas=document.createElement("canvas"),s.ctx=s.canvas.getContext("2d");const a=e.uploaderid++;t.addEventListener("dragover",e.actionNone,!1),t.addEventListener("dragenter",e.actionNone,!1),t.actionDrop=t=>{const a=t.dataTransfer.files;return e.doUpload(a,i),t.preventDefault(),t.stopPropagation(),!1},t.addEventListener("drop",t.actionDrop,!1),t.actionClick=()=>{document.getElementById("ameyaretouchtmpinput"+a).dispatchEvent(new MouseEvent("click"))},t.addEventListener("click",t.actionClick,!1),document.body.appendChild(e.createEl("input",{type:"file",multiple:"multiple",id:"ameyaretouchtmpinput"+a,style:"display:none;"},"")),document.getElementById("ameyaretouchtmpinput"+a).addEventListener("change",t=>{const a=t.target.files;e.doUpload(a,i)},!1)}(t,i)}static resetUploadArea(t,i){t.removeEventListener("dragover",e.actionNone),t.removeEventListener("dragenter",e.actionNone),t.removeEventListener("drop",t.actionDrop),t.removeEventListener("click",t.actionClick)}static actionNone(e){return e.preventDefault(),e.stopPropagation(),!1}static doUpload(t,i){Array.from(t).forEach(t=>{e.load(t,()=>{if(i.original&&(i.original.success||(i.original.success=null),i.original.failure||(i.original.failure=null),e.downsizing(1,0),e.save(i.original.url,i.original.param,i.original.success,i.original.failure)),i.size)for(let t=0;t<i.size.length;t++){if(this.img=this.orimg,i.size[t].success||(i.size[t].success=null),i.size[t].failure||(i.size[t].failure=null),i.size[t].width/i.size[t].height>this.img.width/this.img.height){const a=this.img.width*i.size[t].height/i.size[t].width;e.crop(0,(this.img.height-a)/2,this.img.width,a,1),e.downsizing(i.size[t].width/this.img.width,0)}else{const a=this.img.height*i.size[t].width/i.size[t].height;e.crop((this.img.width-a)/2,0,a,this.img.height,1),e.downsizing(i.size[t].height/this.img.height,0)}e.save(i.size[t].url,i.size[t].param,i.size[t].success,i.size[t].failure)}})})}static openTemperature(){c.openMask(),c.addMaskFilter("ameyaretouchtemperature",n.of("temperature"),6600,15e3,1e3,100,e.tuneTemperature),c.addEventListener(()=>{e.saveHistory(e.img),c.deleteMaskFilter("ameyaretouchtemperature");const t=document.createElement("canvas"),i=t.getContext("2d"),a=s.canvas.getContext("2d").getImageData(0,0,s.canvas.width,s.canvas.height);t.width=s.canvas.width,t.height=s.canvas.height,i.putImageData(a,0,0),e.img=t,e.updateProperty()},()=>{c.deleteMaskFilter("ameyaretouchtemperature")})}static openBlur(t){t&&(this.blursetting=Object.assign(this.blursetting,t)),c.openMask(),c.addEventListener(()=>{let t=document.createElement("canvas"),i=t.getContext("2d"),a=s.canvas.getContext("2d").getImageData(0,0,s.canvas.width,s.canvas.height),n=a.data,o=n.slice(),r=n.slice(),c=4*s.canvas.width,h=function(e,t){const i=t-c,a=t+c;return(r[i-4+e]+r[i+e]+r[i+4+e]+r[t-4+e]+r[t+e]+r[t+4+e]+r[a-4+e]+r[a+e]+r[a+4+e])/9},d=document.querySelector("#ameyaretouchmask canvas").getContext("2d").getImageData(0,0,s.canvas.width,s.canvas.height).data;t.width=s.canvas.width,t.height=s.canvas.height,e.saveHistory(e.img);for(let t=0;t<e.blursetting.power;t++){for(let e=c;e<r.length-c;e+=4)e%c!=0&&e%c!=c-1&&(n[e]=h(0,e),n[e+1]=h(1,e),n[e+2]=h(2,e));r=n.slice()}for(let e=0;e<r.length;e+=4){const t=d[e+3]/255;n[e]=r[e]*t+o[e]*(1-t),n[e+1]=r[e+1]*t+o[e+1]*(1-t),n[e+2]=r[e+2]*t+o[e+2]*(1-t)}i.putImageData(a,0,0),e.img=t,e.updateProperty()});let i,a=!1,n=document.querySelector("#ameyaretouchmask canvas"),o=n.getContext("2d");n.addEventListener("mousedown",()=>{a=!0},!1),n.addEventListener("mousemove",t=>{a&&(i=o.createRadialGradient(t.offsetX,t.offsetY,0,t.offsetX,t.offsetY,.5*e.blursetting.width),i.addColorStop(0,"rgba(255,0,0,"+e.blursetting.opacity+")"),i.addColorStop(.5,"rgba(255,0,0,"+e.blursetting.opacity+")"),i.addColorStop(1,"rgba(255,0,0,0)"),o.fillStyle=i,o.beginPath(),o.arc(t.offsetX,t.offsetY,.5*e.blursetting.width,0,2*Math.PI),o.fill())},!1),n.addEventListener("mouseup",()=>{a=!1},!1),n.addEventListener("mouseout",()=>{a=!1},!1)}static initSizeFix(){this.translate={x:0,y:0},this.updateScale()}static changeSizeFix(e,t){this.pref.sizefixw=e,this.pref.sizefixh=t,this.initSizeFix()}static updateScale(){let e=5e3,t=1e3,i=1;this.pref&&this.pref.sizefix?(e=1e3,i=t=Math.max(1e3*this.pref.sizefixw/this.img.width,1e3*this.pref.sizefixh/this.img.height)):(5*this.img.width>this.IMAGEMAXSIZE&&(e=Math.min(Math.floor(this.IMAGEMAXSIZE/this.img.width*1e3),e)),5*this.img.height>this.IMAGEMAXSIZE&&(e=Math.min(Math.floor(this.IMAGEMAXSIZE/this.img.height*1e3),e)),e<t&&(t=e));const a=document.getElementById("ameyaretouchscale");a&&(a.setAttribute("max",String(e)),a.value=String(t),this.pref.sizefix&&a.setAttribute("min",String(i)))}static updateRotate(){document.getElementById("ameyaretouchrotate").value="0"}static updateContrast(){document.getElementById("ameyaretouchcontrast").value="25"}static updateBrightness(){document.getElementById("ameyaretouchbrightness").value="127"}static updateProperty(){e.updateScale(),e.updateRotate(),e.updateContrast(),e.updateBrightness()}static eachEl(e,t){Array.from(document.querySelectorAll(e)).forEach(t)}static createEl(e,t,i){const a=document.createElement(e);return Object.keys(t).forEach(e=>{a.setAttribute(e,t[e])}),a.innerHTML=i,a}}return e.IMAGEMAXSIZE=1024,e.rotate=0,e.scale=1,e.filters=[],e.uploaderid=0,e.history=[],e.blursetting={width:30,opacity:.5,power:1},e.translate={x:0,y:0},e})();window.AmeyaRetouch=h}]);